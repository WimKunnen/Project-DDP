#include <stdint.h>
#include "common.h"

// a and b of length SIZE and t of length 2*SIZE
void multiply_reference(uint32_t* a, uint32_t* b, uint32_t* t, uint32_t SIZE) {
	uint32_t i;
	uint32_t j;
	for(i=0;i<2*SIZE+1;i++){
		t[i] = 0;
	}
	for(i=0; i<SIZE; i++)
	{
		uint32_t c = 0;
		for(j=0;j<SIZE;j++){
			uint64_t sum = (uint64_t)t[i+j] + (uint64_t)a[j] * (uint64_t)b[i] + (uint64_t)c;
			uint32_t s = (uint32_t)sum;
			c = (uint32_t)(sum >> 32);
			t[i+j] = s;
		}
		t[i+SIZE] = c;
	}
}

void print_arr(uint32_t* arr, uint32_t size) {
	int32_t i;
	xil_printf("0x");
	for(i=size-1;i>=0;i--) {
		xil_printf("%08x", arr[i]);
	}
	xil_printf("\r\n\r\n");
}

int compare(uint32_t* cmp, uint32_t* expected, uint32_t size) {
	uint32_t i;
	for(i=0; i<size; i++) {
		if(cmp[i] != expected[i]) {
			xil_printf("Exp: ");
			print_arr(expected, 8);
			xil_printf("Got: ");
			print_arr(cmp, 8);
			return 1;
		}
	}
	return 0;
}

int test_reference() {
	uint32_t result[8];
	uint32_t a[4] = {0x2c4f70b8, 0xacbfddee, 0x0e2b9e8a, 0xc29b1894};
	uint32_t b[4] = {0x7b02886a, 0x466bab9c, 0x93235825, 0x58a33b52};
	multiply_reference(a, b, result, 4);
	uint32_t expected[8] = {0xd6366c30, 0x1e1a880f, 0x0094f7ad, 0xce86f14d, 0x63a40ae9, 0x3bf760f5, 0x0f55f049, 0x4361664c};

	if (compare(result, expected, 8) != 0) {
		xil_printf("Failure:\r\n");
		return 1;
	}
	
	uint32_t c[4] = {0xdc6a874b, 0xb1e51742, 0xbf9e348f, 0xee1c6af1};
	uint32_t d[4] = {0x93d69b7a, 0x81715423, 0x0e084b48, 0x203388da};
	expected = {0xb460e2be, 0xecc8194f, 0x89f76cce, 0xc4478f7e, 0x5e2db326, 0xfb43720f, 0x702db781, 0x1df37c51};
	multiply_reference(c, d, result, 4);
	//expected = {0xd6366c30, 0x1e1a880f, 0x0094f7ad, 0xce86f14d, 0x63a40ae9, 0x3bf760f5, 0x0f55f049, 0x4361664c};

	if (compare(result, expected, 8) != 0) {
		xil_printf("Failure:\r\n");
		return 1;
	}
	return 0;
}

void test() {
	xil_printf("Starting tests...\r\n");
	test_reference();
}
